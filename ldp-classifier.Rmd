---
title: "ldp classifier"
author: "Flora Zhang and Dan Yurovsky"
date: "2/21/2019"
output: html_document
---

```{r}
library(tidyverse)
library(lme4)
library(here)
library(boot)
library(broom)
library(naivebayes)
library(irr)
```

```{r old_data}
child_data <- read_tsv(here("data/ldp_child.csv")) %>%
  mutate(person = "child") %>%
  select(-X1)

parent_data <- read_tsv(here("data/ldp_parent.csv")) %>%
  mutate(person = "parent") %>%
  select(-X1)


all_data <- bind_rows(child_data, parent_data) %>%
  select(-id) %>%
  filter(!is.na(cnt_3S)) %>%
  mutate(person = as.numeric(factor(person, levels = c("parent", "child"))) - 1) 


train_data <- all_data %>%
  ungroup() %>%
  sample_frac(.8)

# not right
test_data <- anti_join(train_data, all_data)

test_data <- all_data %>%
  ungroup() %>%
  sample_frac(.2)

model <- glm(person ~ ., family = "binomial",data = train_data)

predicted_data <- test_data %>% 
  mutate(prediction = inv.logit(predict(model, newdata = .))) %>%
  mutate(is_child = prediction > .5)

```


```{r}

model <- glm(person ~ ., family = "binomial",data = all_data)


features <- tidy(model)

features %>%
  arrange(desc(abs(statistic)))

predicted_data <- all_data %>% 
  mutate(prediction = inv.logit(predict(model))) %>%
  mutate(is_child = prediction > .5)

cor.test(predicted_data$prediction, predicted_data$person)
```


```{r}
all_data %>%
  group_by(person) %>%
  summarise(bool_question = mean(bool_question, na.rm = T),
            cnt_MentalStateVerb = mean(cnt_MentalStateVerb))
```


```{r}
acc_data <- predicted_data %>%
  group_by(person, is_child) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  mutate(person = if_else(person == 0, "parent", "child"),
         predicted_person = if_else(is_child, "child", "parent"))


tp <-  acc_data %>%
  filter(person == "child" & predicted_person == "child") %>%
  summarise(n = sum(n)) %>%
  pull(n)

fp <- acc_data %>%
  filter(person == "parent", predicted_person == "child") %>%
  summarise(n = sum(n)) %>%
  pull(n)

fn <- acc_data %>%
  filter(person == "child", predicted_person == "parent") %>%
  summarise(n = sum(n)) %>%
  pull(n)


precision <- tp / (tp + fp)
recall <- tp / (tp + fn)

f <- (2 * (precision * recall)) / (precision + recall)
```


```{r new_data}
all_data <- read_tsv(here("data/02122019processed_alldata_with_identity_session_col.csv")) %>%
  select(-X, -id, -chat:-syntype, -identity_session)

nb <- all_data %>%
  filter(session == 5) %>%
  select(-session, -subject) %>%
  mutate(identity_binary = as.logical(identity_binary)) %>%
  naive_bayes(identity_binary ~ ., data = .)

all_data_predicted <- all_data %>%
  filter(session == 5) %>%
  select(-session, -subject) %>%
  mutate(predicted = as.numeric(predict(nb))-1)%>%
  group_by(identity_binary, predicted) %>%
  summarise(n = n()) 

p_tp <- all_data_predicted %>%
  filter(identity_binary == 0 & predicted == 0) %>%
  pull(n)

p_fp <- all_data_predicted %>%
  filter(identity_binary == 1 & predicted == 0) %>%
  pull(n)

p_tn <- all_data_predicted %>%
  filter(identity_binary == 1 & predicted == 1) %>%
  pull(n)

p_fn <- all_data_predicted %>%
  filter(identity_binary == 0 & predicted == 1) %>%
  pull(n)


p_precision <- p_tp / (p_tp + p_tn)
p_recall <- p_tp / (p_tp + p_fn)
p_f <- (2 * p_precision * p_recall) / (p_precision + p_recall)

c_tp <- all_data_predicted %>%
  filter(identity_binary == 1 & predicted == 1) %>%
  pull(n)

c_fp <- all_data_predicted %>%
  filter(identity_binary == 0 & predicted == 1) %>%
  pull(n)

c_tn <- all_data_predicted %>%
  filter(identity_binary == 0 & predicted == 0) %>%
  pull(n)

c_fn <- all_data_predicted %>%
  filter(identity_binary == 1 & predicted == 0) %>%
  pull(n)


c_precision <- c_tp / (c_tp + c_tn)
c_recall <- c_tp / (c_tp + c_fn)
c_f <- (2 * c_precision * c_recall) / (c_precision + c_recall)


cor(all_data_predicted$identity_binary, all_data_predicted$predicted)

kappa2(all_data_predicted[c("identity_binary", "predicted")])


```